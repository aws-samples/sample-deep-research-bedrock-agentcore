#!/usr/bin/env node
/**
 * Generate Frontend Model Configuration from Backend JSON
 *
 * This script reads shared/model_registry.json and generates
 * frontend/src/config/modelRegistry.js automatically.
 *
 * Run this before building the frontend to ensure consistency.
 */

const fs = require('fs');
const path = require('path');

// Paths
const PROJECT_ROOT = path.join(__dirname, '..');
const JSON_PATH = path.join(PROJECT_ROOT, 'shared', 'model_registry.json');
const OUTPUT_PATH = path.join(PROJECT_ROOT, 'frontend', 'src', 'config', 'modelRegistry.js');

console.log('üîß Generating frontend model configuration...');
console.log(`üìñ Reading: ${JSON_PATH}`);

// Read JSON
let registry;
try {
  const jsonContent = fs.readFileSync(JSON_PATH, 'utf8');
  registry = JSON.parse(jsonContent);
} catch (error) {
  console.error('‚ùå Failed to read model registry JSON:', error.message);
  process.exit(1);
}

// Convert to JavaScript format
const jsContent = `/**
 * Model Registry - Auto-generated from shared/model_registry.json
 * DO NOT EDIT THIS FILE MANUALLY!
 *
 * To add a new model:
 * 1. Edit shared/model_registry.json
 * 2. Run: npm run generate-config (or it runs automatically on build)
 *
 * Generated: ${new Date().toISOString()}
 */

export const MODELS = ${JSON.stringify(registry.models, null, 2)};

export const ALIASES = ${JSON.stringify(registry.aliases, null, 2)};

/**
 * Get model info by ID (resolves aliases)
 */
export function getModel(modelId) {
  const resolvedId = ALIASES[modelId] || modelId;
  return MODELS[resolvedId];
}

/**
 * Get list of models for dropdown (filtered by usage)
 */
export function getModelOptions(recommendedFor = null) {
  let models = Object.values(MODELS);

  if (recommendedFor) {
    models = models.filter(m => m.recommended_for && m.recommended_for.includes(recommendedFor));
  }

  return models.map(m => ({
    value: m.id,
    label: m.label,
    description: m.description
  }));
}

/**
 * Format model ID to display name
 */
export function formatModelName(modelId) {
  const model = getModel(modelId);
  return model ? model.label : modelId;
}

// Legacy exports for backward compatibility
export const LLM_MODELS = getModelOptions('research');
export const CHAT_MODELS = getModelOptions('chat');
`;

// Write output
try {
  // Ensure directory exists
  const outputDir = path.dirname(OUTPUT_PATH);
  if (!fs.existsSync(outputDir)) {
    fs.mkdirSync(outputDir, { recursive: true });
  }

  fs.writeFileSync(OUTPUT_PATH, jsContent, 'utf8');
  console.log(`‚úÖ Generated: ${OUTPUT_PATH}`);
  console.log(`üìä Models: ${Object.keys(registry.models).length}`);
  console.log(`üîó Aliases: ${Object.keys(registry.aliases).length}`);
} catch (error) {
  console.error('‚ùå Failed to write output file:', error.message);
  process.exit(1);
}

console.log('‚ú® Model configuration generated successfully!');
